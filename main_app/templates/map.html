{% extends 'base.html' %}

{% block content %}
<!-- Map container -->
<div id="map"></div>

<!-- Locate Me button under the map -->
<div class="locate-btn" id="locateBtn">üìç My location</div>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<style>
  #map { height: 80vh; width: 100%; margin-bottom: 12px; }
  .leaflet-popup-content img {
    width: 100%;
    max-height: 140px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 8px;
    display: block;
  }
  .locate-btn {
    display: inline-block;
    background: white;
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    cursor: pointer;
    font-family: system-ui, sans-serif;
    font-size: 14px;
  }
</style>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  const BAHRAIN_CENTER = [26.0667, 50.5577];
  const DEFAULT_ZOOM = 11;

  const map = L.map('map', { zoomControl: true }).setView(BAHRAIN_CENTER, DEFAULT_ZOOM);

  // Bahrain bounds
  const bahrainBounds = L.latLngBounds([25.55, 50.30], [26.40, 50.90]);
  map.setMaxBounds(bahrainBounds.pad(0.2));
  map.on('drag', function() {
    map.panInsideBounds(bahrainBounds.pad(0.4), { animate: false });
  });

  // Tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Auto locate user
  map.locate({ setView: true, maxZoom: 14, watch: false });
  map.on('locationerror', () => {
    map.setView(BAHRAIN_CENTER, DEFAULT_ZOOM);
  });

  // Locate Me button
  document.getElementById('locateBtn').addEventListener('click', () => {
    map.locate({ setView: true, maxZoom: 14, watch: false });
  });

  // Escape HTML
  function escapeHtml(text) {
    const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
    return String(text || '').replace(/[&<>"']/g, m => map[m]);
  }

  // Load universities
  fetch("{% url 'universities_geojson' %}")
    .then(res => res.json())
    .then(geojson => {
      L.geoJSON(geojson, {
        pointToLayer: (feature, latlng) => L.marker(latlng, { title: feature.properties.name }),
        onEachFeature: (feature, layer) => {
          const p = feature.properties || {};
          const img = p.image_url ? `<img src="${p.image_url}" alt="${escapeHtml(p.name)}">` : '';
          const website = p.website ? `<p><a href="${p.website}" target="_blank" rel="noopener noreferrer">Visit website</a></p>` : '';
          const email = p.email ? `<p>Email: <a href="mailto:${p.email}">${escapeHtml(p.email)}</a></p>` : '';
          const phone = p.phone ? `<p>Phone: <a href="tel:${p.phone}">${escapeHtml(p.phone)}</a></p>` : '';

          const html = `
            <div style="width:260px">
              ${img}
              <h4 style="margin:0 0 6px 0;">${escapeHtml(p.name)}</h4>
              <p style="margin:0 0 6px 0;">${escapeHtml(p.description || '')}</p>
              ${website}
              ${email}
              ${phone}
            </div>
          `;
          layer.bindPopup(html);
        }
      }).addTo(map);
    })
    .catch(err => console.error('Failed to load universities:', err));
</script>
{% endblock %}
